<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Registro de Estudiantes</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
 :root {
  --primary: #4e73df;
  --secondary: #1cc88a;
  --danger: #e74a3b;
  --bg: #f8f9fc;
  --surface: #ffffff;
  --text: #5a5c69;
  --radius: 8px;
  --transition: 0.3s;
  --spacing: 1rem;
 }
 * { box-sizing: border-box; margin: 0; padding: 0; }
 body {
  font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text);
  line-height: 1.5; display: flex; flex-direction: column; min-height: 100vh;
 }
 header { background: var(--primary); color: #fff; padding: var(--spacing); text-align: center; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
 header h1 { font-size: 2rem; font-weight: 700; }
 main {
  flex: 1; max-width: 960px; margin: var(--spacing) auto; padding: var(--spacing);
  background: var(--surface); border-radius: var(--radius); box-shadow: 0 4px 12px rgba(0,0,0,0.05);
 }
 .accordion { margin-bottom: var(--spacing); border-radius: var(--radius); overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: box-shadow var(--transition); }
 .accordion:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
 .accordion summary {
  display: flex; justify-content: space-between; align-items: center; padding: var(--spacing);
  font-weight: 600; cursor: pointer; background: var(--primary); color: #fff; list-style: none;
 }
 .accordion summary::-webkit-details-marker { display: none; }
 .accordion summary::after { content: '▾'; transition: transform var(--transition); }
 .accordion[open] summary::after { transform: rotate(180deg); }
 .accordion .content { padding: var(--spacing); background: var(--bg); }

 .student, .result-item {
  display: flex; align-items: center; justify-content: space-between; padding: var(--spacing);
  background: var(--surface); border-radius: var(--radius); box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin-bottom: 0.75rem; transition: transform var(--transition);
 }
 .student:hover, .result-item:hover { transform: translateY(-2px); }

 .fields {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 0.75rem; margin-top: 0.5rem;
 }
 .fields input {
  width: 100%; padding: 0.5rem; border: 1px solid #d1d3e2; border-radius: var(--radius);
  transition: border-color var(--transition), box-shadow var(--transition);
 }
 .fields input:focus { border-color: var(--primary); outline: none; }

 /* === Estilos de validación === */
 .fields input.invalid {
  border-color: var(--danger);
  box-shadow: 0 0 0 3px rgba(231,74,59,0.15);
 }
 .error-hint {
  display: block;
  color: var(--danger);
  font-size: 0.85rem;
  margin-top: 0.25rem;
 }

 button {
  font-family: inherit; font-weight: 600; font-size: 1rem; padding: 0.6rem 1.2rem;
  border: none; border-radius: var(--radius); cursor: pointer; transition: background var(--transition), transform var(--transition);
 }
 .btn-primary { background: var(--primary); color: #fff; }
 .btn-primary:hover { filter: brightness(0.9); }
 .btn-secondary { background: var(--secondary); color: #fff; }
 .btn-secondary:hover { filter: brightness(0.9); }
 .btn-delete { background: var(--danger); color: #fff; font-size: 0.9rem; padding: 0.4rem 0.8rem; }
 .btn-delete:hover { filter: brightness(0.9); }
 .btn-add { margin-top: var(--spacing); }

 #group-summaries {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing);
 }
 .summary-group > summary { background: var(--secondary); color: #fff; padding: var(--spacing); font-size: 1.1rem; }
 #failure-title, #failure-table, #chart-container { display: none; }

 #failure-table {
  width: 100%; border-collapse: collapse; margin-top: var(--spacing);
 }
 #failure-table th, #failure-table td {
  padding: 0.75rem 1rem; text-align: center; border-bottom: 1px solid #e3e6f0;
 }
 #failure-table tr:nth-child(even) { background: #f8f9fc; }

 #chart-container { margin-top: var(--spacing); text-align: center; }
 canvas { max-width: 100%; height: auto; }
</style>
</head>
<body>
<header>
 <h1>Registro de Estudiantes</h1>
</header>
<main>
 <details class="accordion" id="students-accordion" open>
  <summary>Alumnos capturados (<span id="student-count"></span>)</summary>
  <div class="content">
   <div id="students-container"></div>
   <button type="button" class="btn-secondary btn-add" id="add-student">Agregar alumno</button>
  </div>
 </details>

 <details class="accordion" id="summary-accordion" open>
  <summary>Resumen</summary>
  <div class="content" id="group-summaries">
   <details class="summary-group" open>
    <summary>Grupo A</summary>
    <div id="group-summary-A"></div>
   </details>
   <details class="summary-group" open>
    <summary>Grupo B</summary>
    <div id="group-summary-B"></div>
   </details>
   <details class="summary-group" open>
    <summary>Grupo C</summary>
    <div id="group-summary-C"></div>
   </details>
  </div>
 </details>

 <div style="text-align: center; margin: var(--spacing) 0;">
  <button id="calculate-btn" class="btn-primary">Calcular y Graficar</button>
 </div>

 <h2 id="failure-title">Índice de Reprobación</h2>
 <table id="failure-table">
  <thead>
   <tr><th>Grupo</th><th>Total</th><th>Reprobados</th><th>% Reprobación</th></tr>
  </thead>
  <tbody></tbody>
 </table>

 <div id="chart-container"><canvas id="groupChart"></canvas></div>
</main>

<script>
(function() {
  const container = document.getElementById('students-container');
  const countLabel = document.getElementById('student-count');
  const failureTitle = document.getElementById('failure-title');
  const table = document.getElementById('failure-table');
  const tableBody = table.querySelector('tbody');
  const chartContainer = document.getElementById('chart-container');
  const calculateBtn = document.getElementById('calculate-btn');
  const ctx = document.getElementById('groupChart').getContext('2d');
  let chart;

  function randNote() { return (Math.random() * 5 + 5).toFixed(1); }
  function updateCount() { countLabel.textContent = container.children.length; }

  // ======== Utilidades de validación ========
  function setError(input, message) {
    input.classList.add('invalid');
    input.setAttribute('aria-invalid', 'true');
    input.title = message;

    // Si no existe un hint, lo creamos justo después del input
    let hint = input.parentElement.querySelector('.error-hint');
    if (!hint || hint.previousElementSibling !== input) {
      hint = document.createElement('small');
      hint.className = 'error-hint';
      input.insertAdjacentElement('afterend', hint);
    }
    hint.textContent = message;
  }

  function clearError(input) {
    input.classList.remove('invalid');
    input.removeAttribute('aria-invalid');
    input.title = '';
    const hint = input.parentElement.querySelector('.error-hint');
    if (hint && hint.previousElementSibling === input) {
      hint.remove();
    }
  }

  function validateNumberInput(input) {
    const raw = input.value.trim();
    if (raw === '') {
      setError(input, 'Campo requerido (0 a 10).');
      return null;
    }
    const val = Number(raw);
    if (!Number.isFinite(val)) {
      setError(input, 'Ingresa un número válido.');
      return null;
    }
    if (val < 0 || val > 10) {
      setError(input, 'El valor debe estar entre 0 y 10.');
      return null;
    }
    // Normalizamos a 1 decimal
    input.value = val.toFixed(1);
    clearError(input);
    return val;
  }

// Validación en tiempo real + límites duros 0–10 + normalización al salir del campo
container.addEventListener('input', (e) => {
  const t = e.target;
  if (!t.matches('.math, .physics, .chemistry')) return;

  // Permitimos que el usuario empiece a escribir sin molestar
  const raw = t.value.trim();
  if (raw === '') {
    // No marcamos error todavía; se validará al calcular o al salir del campo
    return;
  }


  let val = Number(raw.replace(',', '.'));

  if (!Number.isFinite(val)) {
    // Si lo escrito no es número (texto)
    setError(t, 'Ingresa un número válido.');
    return;
  }

  // Recorte duro al rango 0–10
  if (val > 10) val = 10;
  if (val < 0)  val = 0;


  t.value = String(val);


  clearError(t);
});


container.addEventListener('blur', (e) => {
  const t = e.target;
  if (!t.matches('.math, .physics, .chemistry')) return;

  const raw = t.value.trim();
  if (raw === '') {
    setError(t, 'Campo requerido (0 a 10).');
    return;
  }

  let val = Number(raw.replace(',', '.'));
  if (!Number.isFinite(val)) {
    setError(t, 'Ingresa un número válido.');
    return;
  }

  // Garantiza rango 0–10 y deja 1 decimal
  if (val > 10) val = 10;
  if (val < 0)  val = 0;
  t.value = val.toFixed(1);
  clearError(t);
}, true);

  function addStudentBlock(name, group, m, p, c) {
    const div = document.createElement('div');
    div.className = 'student';
    div.innerHTML = `
      <div>
        <strong>${name} (Grupo ${group})</strong>
        <div class="fields">
          <input type="number" class="math" value="${m}" min="0" max="10" step="0.1" placeholder="Matemáticas (0–10)">
          <input type="number" class="physics" value="${p}" min="0" max="10" step="0.1" placeholder="Física (0–10)">
          <input type="number" class="chemistry" value="${c}" min="0" max="10" step="0.1" placeholder="Química (0–10)">
        </div>
      </div>
      <button type="button" class="btn-delete">Eliminar</button>
    `;
    div.querySelector('.btn-delete').addEventListener('click', () => { div.remove(); updateCount(); });

    container.appendChild(div);
    updateCount();
  }

  document.getElementById('add-student').addEventListener('click', () => {
    addStudentBlock('Alumno Nuevo', 'A', '7.0', '7.0', '7.0');
  });

  // ======== Cálculo con validación previa ========
  calculateBtn.addEventListener('click', () => {
    // Reiniciar resúmenes
    ['A','B','C'].forEach(g => { document.getElementById(`group-summary-${g}`).innerHTML = ''; });
    tableBody.innerHTML = '';

    // Validar todos los inputs antes de calcular
    const inputs = container.querySelectorAll('.math, .physics, .chemistry');
    let firstInvalid = null;
    inputs.forEach(inp => {
      const ok = validateNumberInput(inp);
      if (ok === null && !firstInvalid) firstInvalid = inp;
    });

    if (firstInvalid) {
      firstInvalid.focus({ preventScroll: false });
      firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
      return; // Detener: hay errores
    }

    // Construir datos
    const data = { A: [], B: [], C: [] };
    Array.from(container.children).forEach(item => {
      const name = item.querySelector('strong').textContent;
      const g = /Grupo (.)/.exec(name)[1];

      const m = Number(item.querySelector('.math').value);
      const p = Number(item.querySelector('.physics').value);
      const c = Number(item.querySelector('.chemistry').value);

      const avg = +((m + p + c) / 3).toFixed(2);
      data[g].push(avg);

      const res = document.createElement('div');
      res.className = 'result-item';
      res.textContent = `${name}: Promedio ${avg} – ${avg >= 7 ? 'Aprobado' : 'Reprobado'}`;
      document.getElementById(`group-summary-${g}`).appendChild(res);
    });

    // Tabla y promedio por grupo (evitar /0)
    const labels = [];
    const avgs = [];
    Object.entries(data).forEach(([g, arr]) => {
      const total = arr.length;
      const failed = arr.filter(x => x < 7).length;
      const rate = total === 0 ? '0.0' : ((failed / total) * 100).toFixed(1);
      tableBody.innerHTML += `<tr><td>${g}</td><td>${total}</td><td>${failed}</td><td>${rate}%</td></tr>`;

      const groupAvg = total === 0 ? 0 : +(arr.reduce((a, b) => a + b, 0) / total).toFixed(2);
      labels.push(`Grupo ${g}`);
      avgs.push(groupAvg);
    });

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Promedio por Grupo', data: avgs }] },
      options: { responsive: true, scales: { y: { beginAtZero: true, max: 10 } } }
    });

    failureTitle.style.display = 'block';
    table.style.display = 'table';
    chartContainer.style.display = 'block';
  });

  // Precarga de datos
  ['A','B','C'].forEach(g => {
    for (let i = 1; i <= 10; i++) {
      addStudentBlock(`Alumno ${g}${i}`, g, randNote(), randNote(), randNote());
    }
  });
})();
</script>
</body>
</html>

